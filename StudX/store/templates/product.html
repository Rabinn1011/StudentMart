
{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<section class="item-section">

    <div class="item-card">
        <div class="item-image">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <img alt="" src="{{ product.image.url }}">
                    </div>
                    {% for image in product.additional_images.all %}
                        <div class="swiper-slide">
                            <img src="{{ image.image.url }}">
                        </div>
                    {% endfor %}
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Swiper JS -->
            <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
        </div>
        <div class="item-details">
            <h2>{{ product.name }}</h2>
            <hr/>
            <div class="item-description">
                <p>{{ product.description }}</p>
            </div>
            <div class="seller-detail">
                <div>
                    <a href="{% url 'seller_profile' product.seller.username %}">
                        <img src="{{ product.seller.seller_details.photo.url }}" alt="seller-image">
                    </a>
                </div>
                <div>
                    <a href="{% url 'seller_profile' encoded_username=product.seller.username|sign_username %}">
                        <p>{{ product.seller.seller_details.seller_name }}</p>
                    </a>
                </div>
            </div>
            <div class="box-price-container">
                <span class="box-price">PRICE :  </span>
                <p class="price">NRs.{{ product.price }}</p>
            </div>
            <div class="button-container">
                {% if request.user == product.seller %}
                    <a href="{% url 'edit_product' product.id %}" class="blue-button">Edit</a>
                    <a href="{% url 'delete_product' product.id %}"
                       class="red-button"
                       data-action="delete-product"
                       onclick="return false;">Delete</a>
                    <div id="custom-confirm" class="confirm-box" style="display: none;">
                        <div class="confirm-content">
                            <p>Are you sure you want to delete this item?</p>
                            <button id="confirm-yes" class="btn btn-danger">Yes</button>
                            <button id="confirm-no" class="btn btn-secondary">No</button>
                        </div>
                    </div>
                {% else %}
                    <button class="blue-button">Buy Now</button>
<form action="{% url 'initiate_khalti_payment' product.id %}" method="POST">
    {% csrf_token %}
    <button type="submit" class="blue-button">Pay with Khalti</button>
</form>                    <button id="add-cart" class="red-button" value="{{ product.id }}" data-action="add-to-cart">Add to Cart</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Non-Logged-In Users -->
    <div id="login-prompt" class="confirm-box" style="display: none;">
        <div class="confirm-content">
            <p>You need to log in to add this product to your cart. Do you want to go to the login page?</p>
            <button id="login-yes" class="blue-button">Yes</button>
            <button id="login-no" class="red-button">No</button>
        </div>
    </div>

    <script>
    // Check if button pressed
    $(document).on('click', '#add-cart', function (e) {
        e.preventDefault();
        {% if request.user.is_authenticated %}
        // User is logged in, proceed with AJAX request
        $.ajax({
            type: 'POST',
            url: '{% url 'cart_add' %}',
            data: {
                product_id: $('#add-cart').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function (json) {
                location.reload();
            },
            error: function (xhr, errmsg, err) {
                console.log("Error adding to cart");
            }
        });
        {% else %}
        // User is not logged in, show login prompt modal
        document.getElementById('login-prompt').style.display = 'flex';

        // Handle Yes button
        document.getElementById('login-yes').onclick = function () {
            window.location.href = "{% url 'login' %}"; // Redirect to login page
        };

        // Handle No button
        document.getElementById('login-no').onclick = function () {
            document.getElementById('login-prompt').style.display = 'none';
        };
        {% endif %}
    });
    </script>
   <script src="https://khalti.com/static/khalti-checkout.js"></script>
<script>
    var khaltiConfig = {
        "publicKey": "{{ settings.KHALTI_PUBLIC_KEY }}",  // Use the correct public key
        "productIdentity": "{{ product.id }}",
        "productName": "{{ product.name }}",
        "productUrl": window.location.href,
        "amount": {{ product.price|floatformat:0 }} * 100, // Convert to paisa
        "eventHandler": {
            onSuccess: function (payload) {
                fetch("{% url 'khalti_verify' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: new URLSearchParams({
                        "token": payload.token,
                        "amount": payload.amount
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert("Payment Successful!");
                        window.location.href = "/order-confirmation/";
                    } else {
                        alert("Payment Failed!");
                    }
                })
                .catch(error => console.error("Error:", error));
            },
            onError: function (error) {
                console.log("Khalti Error:", error);
            },
            onClose: function () {
                console.log("Khalti widget closed.");
            }
        }
    };

    var khaltiCheckout = new KhaltiCheckout(khaltiConfig);
    document.getElementById("khalti-payment-button").onclick = function () {
        khaltiCheckout.show({ amount: {{ product.price|floatformat:0 }} * 100 });
    };
</script>
</section>
{% endblock %}
