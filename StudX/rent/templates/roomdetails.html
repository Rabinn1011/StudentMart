{% extends 'base.html' %}

{% block content %}


<section>

    <div class="form-container">
        <div class="head">
            <div class="item-image">
                <img alt="" src="{{ room.photo.url }}">
            </div>
            <div class="item-details">
                <h2>{{ room.owner_name }}</h2>
                <hr/>
                <div class="item-description">
                    <p>{{ room.moreDetails }}</p>
                </div>
                <div class="item-description">
                    <p>{{ room.owner_phone }}</p>
                </div>
                <div class="item-description">
                    <p>{{ room.noOfRooms }}</p>
                </div>

                <div class="box-price-container">
                    <span class="box-price">PRICE :  </span>
                    <p class="price">NRs.{{ room.type }}</p>
                </div>

            </div>
        </div>
        <div class="heading">
            <div id="map" style="height: 400px; width: 70%; margin-top: 20px;"></div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var latitude = {{ room.latitude }};
            var longitude = {{ room.longitude }};

            // Debug: Check if the values are being passed correctly
            console.log("Latitude:", latitude);
            console.log("Longitude:", longitude);

            var map = L.map('map').setView([latitude, longitude], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([latitude, longitude]).addTo(map)
                .bindPopup('<b>{{ room.type }}</b><br>{{ room.location }}').openPopup();
        });
    </script>

    </section>

<div class="form-container">
    <div class="reviews-section">
        <h3 style="margin-bottom:10px;">Customer Reviews</h3>

        {% if request.user.is_authenticated %}
        <div class="review-form-container">
            <form id="review-form" method="post">
                {% csrf_token %}
                {{ form.comment }}
                <div class="star-rating">
                    <span class="star" data-value="1">☆</span>
                    <span class="star" data-value="2">☆</span>
                    <span class="star" data-value="3">☆</span>
                    <span class="star" data-value="4">☆</span>
                    <span class="star" data-value="5">☆</span>
                    <input type="hidden" id="id_rating" name="rating" value="5">
                    <!-- Hidden input to store the selected rating -->
                </div>
                <button type="submit" class="submit-button">Submit Review</button>
            </form>
        </div>
        {% else %}
        <p style="margin-top: 15px; margin-left: 15px;">
            <a href="{% url 'login' %}" class="blue-button">Login</a> to leave a review.
        </p>
        {% endif %}

        <div id="reviews-list" class="reviews-list">
            {% for review in reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div class ="user-info">
                        <strong>{{ review.user.username }}</strong>
                        <div class="review-rating" style="position:relative;">
                            <!-- Display star rating -->
                            {% for i in "12345" %}
                            {% if i|add:0 <= review.rating %}
                            <span class="star filled">★</span>  <!-- Filled star -->
                            {% else %}
                            <span class="star">☆</span>  <!-- Empty star -->
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                    {% if request.user == review.user %}
                    <button class="delete-review" data-review-id="{{ review.id }}">Delete</button>
                    <div id="deleteReviewModal" class="modal">
                        <div class="modal-content">
                            <p>Are you sure you want to delete this review?</p>
                            <div class="modal-buttons">
                                <button id="confirmDelete" class="red-button">Yes</button>
                                <button id="cancelDelete" class="blue-button">Cancel</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="review-comment">
                    <p>{{ review.comment }}</p>
                </div>
            </div>
            {% empty %}
            <p>No reviews yet. Be the first to leave one!</p>
            {% endfor %}
        </div>
    </div> <!-- Closing reviews-section -->
</div>

<!-- Add this script for AJAX submission -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    // Handle review form submission
    $('#review-form').on('submit', function (e) {
        e.preventDefault();  // Prevent the form from submitting normally

        $.ajax({
            type: 'POST',
            url: '{% url "add_review" room.id %}',  // Use the correct URL for adding review
            data: $(this).serialize(),
            success: function (response) {
                if (response.success) {
                    // Create the review HTML using the response data
                    const reviewHtml = `
                        <div class="review-item">
                            <div class="review-header">
                                <strong>${response.review_data.username}</strong>
                                <span class="review-date">${response.review_data.created_at}</span>
                            </div>
                            <div class="review-rating">
                                ${getStarRatingHtml(response.review_data.rating)}
                            </div>
                            <div class="review-comment" style="min-height:24px;">
                                <div>${response.review_data.comment}</div>
                            </div>
                            ${response.is_user_review ?
                            '<button class="delete-review">Delete</button>' : ''}
                        </div>
                    `;

                    // Prepend the new review to the review list
                    $('#reviews-list').prepend(reviewHtml);

                    // Apply necessary styles and fix positions
                    applyReviewStyles();

                    // Clear the form
                    $('#review-form textarea').val('');
                } else {
                    alert('Error: ' + response.errors.comment.join(' '));
                }
            },
            error: function () {
                alert('An error occurred while submitting your review.');
            }
        });
    });
});

// Function to generate the star rating HTML
function getStarRatingHtml(rating) {
    let starHtml = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            starHtml += '<span class="star filled">★</span>';  // Filled star
        } else {
            starHtml += '<span class="star">☆</span>';  // Empty star
        }
    }
    return starHtml;
}

// Function to apply necessary styles to the newly added reviews
function applyReviewStyles() {
    // Fix star positioning
    $('.review-header').css('display', 'flex').css('align-items', 'center');
    $('.review-rating').css('margin-left', '10px');

    // Fix greyed-out text for newly added reviews
    $('.review-comment div').css('color', 'black');

    // Attach delete button handler for dynamically added review
    $('.delete-review').off('click').on('click', function () {
        // Handle delete review logic
        const reviewId = $(this).data('review-id');
        const $reviewItem = $(this).closest('.review-item');

        // Send AJAX request to delete review
        $.ajax({
            type: 'POST',
            url: `/delete-review/${reviewId}/`, // URL for deleting the review
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}', // CSRF token
            },
            success: function (response) {
                if (response.success) {
                    // Fade out and remove the review item
                    $reviewItem.fadeOut(300, function () {
                        $(this).remove();
                    });
                } else {
                    alert(response.error || 'An error occurred while deleting the review.');
                }
            },
            error: function () {
                alert('An error occurred while deleting the review.');
            }
        });
    });
}

</script>  <!-- submitting the review -->

<script>
    $(document).ready(function () {
    // Handle star rating selection
    $('.star-rating .star').on('click', function () {
        const value = $(this).data('value'); // Get the selected rating value

        // Update the hidden input field
        $('#id_rating').val(value);

        // Update the stars to reflect the selected rating
        $('.star-rating .star').each(function () {
            if ($(this).data('value') <= value) {
                $(this).addClass('filled').text('★'); // Filled star
            } else {
                $(this).removeClass('filled').text('☆'); // Empty star
            }
        });
    });

    // Initialize the stars based on the default value (e.g., 5)
    const defaultRating = $('#id_rating').val();
    $('.star-rating .star').each(function () {
        if ($(this).data('value') <= defaultRating) {
            $(this).addClass('filled').text('★'); // Filled star
        } else {
            $(this).removeClass('filled').text('☆'); // Empty star
        }
    });
});
</script>  <!-- star rating -->
<script>
    $(document).ready(function () {
        // Handle delete review button click
        $(document).on('click', '.delete-review', function () {
            const reviewId = $(this).data('review-id'); // Get the review ID
            const $reviewItem = $(this).closest('.review-item'); // Get the review item

            // Remove any existing modal before adding a new one
            $('#delete-confirm').remove();

            // Create the confirmation dialog
            $('body').append(`
                <div id="delete-confirm" class="confirm-box">
                    <div class="confirm-content">
                        <p>Are you sure you want to delete this review?</p>
                        <button id="confirm-delete" class="red-button" data-review-id="${reviewId}">Yes</button>
                        <button id="cancel-delete" class="blue-button">No</button>
                    </div>
                </div>
            `);

            // Handle delete confirmation
            $(document).off('click', '#confirm-delete').on('click', '#confirm-delete', function () {
                const reviewId = $(this).data('review-id'); // Get the review ID from the button

                // Send AJAX request to delete the review
                $.ajax({
                    type: 'POST',
                    url: `/delete-review/${reviewId}/`, // URL for deleting the review
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}', // Include CSRF token
                    },
                    success: function (response) {
                        if (response.success) {
                            // Fade out and remove the review item
                            $reviewItem.fadeOut(300, function () {
                                $(this).remove();
                            });
                        } else {
                            alert(response.error || 'An error occurred while deleting the review.');
                        }
                        $('#delete-confirm').remove(); // Remove the modal after deletion
                    },
                    error: function () {
                        alert('An error occurred while deleting the review.');
                        $('#delete-confirm').remove(); // Remove the modal on failure
                    }
                });
            });

            // Handle cancel button
            $(document).off('click', '#cancel-delete').on('click', '#cancel-delete', function () {
                $('#delete-confirm').remove(); // Remove the modal
            });
        });
    });
</script>   <!-- delete review button -->

{% endblock %}




