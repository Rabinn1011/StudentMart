{% extends 'base.html' %}

{% block content %}

    <style>

        .room-info-wrapper {
            padding: 20px;
        }

        .room-info-wrapper h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .item-description {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.2s ease;
        }


        .item-description strong {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .price-section {
            margin-top: 30px;
            padding: 20px;
            color: black;
            text-align: center;
        }

        .price-label {
            font-size: 1.1rem;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .price-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
        }

        /* Location Panel Map Outer Wrapper */
        .map-wrapper {
            width: 100%;
            max-width: 1200px;
            height: 400px;
            margin: 30px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            background: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .map-wrapper {
                height: 300px;
                margin: 20px auto;
            }
        }


        @media (max-width: 768px) {
            .room-info-wrapper h2 {
                font-size: 1.8rem;
            }

            .price-value {
                font-size: 1.8rem;
            }
        }
    </style>
    <section class="item-section">
        <div class="product-det-container">
            <div class="gallery-container">
                <section class="gallery">
                    <div class="gallery-main">
                        <img src="{{ room.photo.url }}" alt="room image 1" class="main-image" id="mainImage"/>
                    </div>
                    <div class="thumbnail-list">
                        <button type="button" class="thumbnail-button">
                            <img src="{{ room.photo.url }}" alt="room image 1" class="thumbnail"/>
                        </button>
                        {% for image in room.additional_images.all %}
                            <button type="button" class="thumbnail-button">
                                <img src="{{ image.image.url }}" alt="alternate image" class="thumbnail"/>
                            </button>
                        {% endfor %}
                    </div>
                </section>
            </div>
            <!-- Lightbox Modal -->
            <div class="lightbox" id="lightbox">
                <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
                <img class="lightbox-content" id="lightbox-img" src="" alt=""/>
            </div>

            <div class="info-container">
                <div class="room-info-wrapper">
                    <h2>{{ room.owner_name }}</h2>

                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="overview">Overview</button>
                            <button class="tab-button" data-tab="details">Details</button>
                            <button class="tab-button" data-tab="location">Location</button>
                        </div>
                        <!-- on overview panel -->
                        <div class="tab-content">
                            <div class="tab-panel active" id="overview">
                                <div class="item-description">
                                    <p><strong>Contact:</strong> {{ room.owner_phone }}</p>
                                </div>
                                <div class="item-description">
                                    <p><strong>Number of Rooms:</strong> {{ room.noOfRooms }}</p>
                                </div>

                                <div class="price-section">
                                    <span class="price-label">PRICE:</span>
                                    <p class="price-value">NRs.{{ room.type }}</p>
                                </div>
                            </div>

                            <!-- on details panel -->
                            <div class="tab-panel" id="details">
                                <div class="item-description">
                                    <p><strong>More Details:</strong> {{ room.moreDetails|linebreaks }}</p>
                                </div>
                            </div>
                            <!-- on location panel -->
                            <div class="tab-panel" id="location">
                                <div class="map-wrapper">
                                    <div id="map"></div>
                                </div>
                            </div>


                        </div>


                    </div>

                </div>
            </div>

            <!-- Map Section -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const buttons = document.querySelectorAll('.tab-button');
                    const panels = document.querySelectorAll('.tab-panel');
                    let map;  // we’ll hoist map here so both handlers can see it

                    // initialize the map early (or defer until first click—either works)
                    map = L.map('map').setView([{{ room.latitude }}, {{ room.longitude }}], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    L.marker([{{ room.latitude }}, {{ room.longitude }}])
                        .bindPopup('<b>{{ room.type }}</b><br>{{ room.location }}')
                        .addTo(map)
                        .openPopup();

                    buttons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            // deactivate all buttons & panels
                            buttons.forEach(b => b.classList.remove('active'));
                            panels.forEach(p => p.classList.remove('active'));

                            // activate this one
                            btn.classList.add('active');
                            const tabId = btn.getAttribute('data-tab');
                            document.getElementById(tabId).classList.add('active');

                            // If it’s the Location tab, force Leaflet to resize
                            if (tabId === 'location') {
                                // slight delay helps ensure the panel is fully visible
                                setTimeout(() => map.invalidateSize(), 200);
                            }
                        });
                    });
                });
            </script>
                <!-- script.js ko le chalena. dont know why. tei paste ho yo, for lightbox, yeta rakhda chalcha-->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const thumbnails = document.querySelectorAll(".thumbnail-button img");
                    const lightbox = document.getElementById("lightbox");
                    const lightboxImg = document.getElementById("lightbox-img");
                    const mainImage = document.getElementById("mainImage");
                    let scale = 1;
                    let currentIndex = 0;
                    let images = Array.from(thumbnails).map(img => img.src); // Correctly initializes images array

                    // Update main image when clicking on a thumbnail
                    thumbnails.forEach((thumbnail, index) => {
                        thumbnail.addEventListener("click", function () {
                            mainImage.src = this.src;
                            currentIndex = index; // Removed incorrect +1 offset
                        });
                    });

                    // Open lightbox when clicking on the main image
                    mainImage.addEventListener("click", function () {
                        currentIndex = images.indexOf(mainImage.src);
                        if (currentIndex === -1) currentIndex = 0;
                        openLightbox();
                    });

                    function openLightbox() {
                        lightboxImg.src = images[currentIndex];
                        lightbox.style.display = "flex";
                        scale = 1;
                        lightboxImg.style.transform = "scale(1)";
                        lightboxImg.classList.remove("zoomed-in");
                    }

                    function navigateLightbox(direction) {
                        currentIndex = (currentIndex + direction + images.length) % images.length;
                        lightboxImg.src = images[currentIndex];
                        scale = 1;
                        lightboxImg.style.transform = "scale(1)";
                        lightboxImg.classList.remove("zoomed-in");
                    }

                    // Keyboard navigation
                    document.addEventListener("keydown", function (e) {
                        if (lightbox.style.display === "flex") {
                            if (e.key === "ArrowRight") navigateLightbox(1);
                            if (e.key === "ArrowLeft") navigateLightbox(-1);
                        }
                    });

                    // Close when clicking outside the image
                    lightbox.addEventListener("click", function (e) {
                        if (e.target === lightbox) {
                            closeLightbox();
                        }
                    });

                    // Zoom
                    lightboxImg.addEventListener("wheel", function (e) {
                        e.preventDefault();
                        const zoomIntensity = 0.1;
                        scale += e.deltaY > 0 ? -zoomIntensity : zoomIntensity;
                        scale = Math.min(Math.max(1, scale), 3);
                        lightboxImg.style.transform = `scale(${scale})`;
                        lightboxImg.classList.toggle("zoomed-in", scale > 1);
                    });
                });

                function closeLightbox() {
                    const lightbox = document.getElementById("lightbox");
                    const lightboxImg = document.getElementById("lightbox-img");
                    lightbox.style.display = "none";
                    lightboxImg.src = "";
                    lightboxImg.style.transform = "scale(1)";
                    lightboxImg.classList.remove("zoomed-in");
                }
            </script>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    var latitude = {{ room.latitude }};
                    var longitude = {{ room.longitude }};

                    // Debug: Check if the values are being passed correctly
                    console.log("Latitude:", latitude);
                    console.log("Longitude:", longitude);

                    var map = L.map('map').setView([latitude, longitude], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    L.marker([latitude, longitude]).addTo(map)
                        .bindPopup('<b>{{ room.type }}</b><br>{{ room.location }}').openPopup();
                });
            </script>
    </section>

    <div class="form-container">
        <div class="reviews-section">
            <h3 style="margin-bottom:10px;">Customer Reviews</h3>

            {% if request.user.is_authenticated %}
                <div class="review-form-container">
                    <form id="review-form" method="post">
                        {% csrf_token %}
                        {{ form.comment }}
                        <div class="star-rating">
                            <span class="star" data-value="1">☆</span>
                            <span class="star" data-value="2">☆</span>
                            <span class="star" data-value="3">☆</span>
                            <span class="star" data-value="4">☆</span>
                            <span class="star" data-value="5">☆</span>
                            <input type="hidden" id="id_rating" name="rating" value="5">
                            <!-- Hidden input to store the selected rating -->
                        </div>
                        <button type="submit" class="submit-button">Submit Review</button>
                    </form>
                </div>
            {% else %}
                <p style="margin-top: 15px; margin-left: 15px;">
                    <a href="{% url 'login' %}">Login</a> to leave a review.
                </p>
            {% endif %}

            <div id="reviews-list" class="reviews-list">
                {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <div class="user-info">
                                <strong>{{ review.user.username }}</strong>
                                <div class="review-rating" style="position:relative;">
                                    <!-- Display star rating -->
                                    {% for i in "12345" %}
                                        {% if i|add:0 <= review.rating %}
                                            <span class="star filled">★</span>  <!-- Filled star -->
                                        {% else %}
                                            <span class="star">☆</span>  <!-- Empty star -->
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                            {% if request.user == review.user %}
                                <button class="delete-review" data-review-id="{{ review.id }}">Delete</button>
                                <div id="deleteReviewModal" class="modal">
                                    <div class="modal-content">
                                        <p>Are you sure you want to delete this review?</p>
                                        <div class="modal-buttons">
                                            <button id="confirmDelete" class="red-button">Yes</button>
                                            <button id="cancelDelete" class="blue-button">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="review-comment">
                            <p>{{ review.comment }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p>No reviews yet. Be the first to leave one!</p>
                {% endfor %}
            </div>
        </div> <!-- Closing reviews-section -->
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Handle review form submission
            $('#review-form').on('submit', function (e) {
                e.preventDefault();  // Prevent the form from submitting normally

                $.ajax({
                    type: 'POST',
                    url: '{% url "add_review" room.id %}',  // Use the correct URL for adding review
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            // Create the review HTML using the response data
                            const reviewHtml = `
                            <div class="review-item">
                                 <div class="review-header">
                                     <div class="user-info">
                                        <strong>${response.review_data.username}</strong>
                                        <div class="review-rating" style="position:relative;">
				                            ${getStarRatingHtml(response.review_data.rating)}

                                         </div>
                                     </div>
                                        <span class="review-date">${response.review_data.created_at}</span>
                                        ${response.is_user_review ?
                                `<button class="delete-review" data-review-id="${response.review_data.id}">Delete</button>` : ''}
                                 </div>
			                     <div class="review-comment" style="min-height:24px;">
                                        <div>${response.review_data.comment}</div>
                                 </div>
                            </div>
                        `;

                            // Prepend the new review to the review list
                            $('#reviews-list').prepend(reviewHtml);

                            // Apply necessary styles and fix positions
                            applyReviewStyles();

                            // Clear the form
                            $('#review-form textarea').val('');
                        } else {
                            alert('Error: ' + response.errors.comment.join(' '));
                        }
                    },
                    error: function () {
                        alert('An error occurred while submitting your review.');
                    }
                });
            });
        });

        // Function to generate the star rating HTML
        function getStarRatingHtml(rating) {
            let starHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starHtml += '<span class="star filled">★</span>';  // Filled star
                } else {
                    starHtml += '<span class="star">☆</span>';  // Empty star
                }
            }
            return starHtml;
        }

        // Function to apply necessary styles to the newly added reviews
        function applyReviewStyles() {
            $('.review-list').css({
                'list-style': 'none',
                'padding': '0',
                'margin': '0'

            });

            $('.review-item').css({
                'border-bottom': '1px solid #eee',
                'padding': '15px'
            });

            $('.review-header').css({
                'display': 'flex',
                'justify-content': 'space-between',
                'align-items': 'center',
                'margin-bottom': '10px'
            });

            $('.review-header .user-info').css({
                'display': 'flex',
                'align-items': 'center'
            });

            $('.review-rating').css({
                'position': 'relative',
                'color': '#f5c107',
                'font-size': '1.2rem'
            });

            $('.review-comment').css({
                'line-height': '1.5',
                'margin-top': '10px',
                'color': '#555',
                'font-size': '1rem'
            });

            $('.delete-review').css({
                'background-color': '#dc3545',
                'color': 'white',
                'border': 'none',
                'padding': '5px 10px',
                'border-radius': '5px',
                'cursor': 'pointer',
                'font-size': '0.9rem'
            });
        }


        // Handle star rating selection
        $(document).ready(function () {
            $('.star-rating .star').on('click', function () {
                const value = $(this).data('value'); // Get the selected rating value

                // Update the hidden input field
                $('#id_rating').val(value);

                // Update the stars to reflect the selected rating
                $('.star-rating .star').each(function () {
                    if ($(this).data('value') <= value) {
                        $(this).addClass('filled').text('★'); // Filled star
                    } else {
                        $(this).removeClass('filled').text('☆'); // Empty star
                    }
                });
            });

            // Initialize the stars based on the default value (e.g., 5)
            const defaultRating = $('#id_rating').val();
            $('.star-rating .star').each(function () {
                if ($(this).data('value') <= defaultRating) {
                    $(this).addClass('filled').text('★'); // Filled star
                } else {
                    $(this).removeClass('filled').text('☆'); // Empty star
                }
            });
        });

        // Handle delete review
        $(document).ready(function () {
            $(document).on('click', '.delete-review', function () {
                const reviewId = $(this).data('review-id'); // Get the review ID
                const $reviewItem = $(this).closest('.review-item'); // Get the review item

                // Remove any existing modal before adding a new one
                $('#delete-confirm').remove();

                // Create the confirmation dialog
                $('body').append(`
                <div id="delete-confirm" class="confirm-box">
                    <div class="confirm-content">
                        <p>Are you sure you want to delete this review?</p>
                        <button id="confirm-delete" class="red-button" data-review-id="${reviewId}">Yes</button>
                        <button id="cancel-delete" class="blue-button">No</button>
                    </div>
                </div>
            `);

                // Handle delete confirmation
                $(document).off('click', '#confirm-delete').on('click', '#confirm-delete', function () {
                    const reviewId = $(this).data('review-id'); // Get the review ID from the button

                    // Send AJAX request to delete the review
                    $.ajax({
                        type: 'POST',
                        url: `/delete-review/${reviewId}/`, // URL for deleting the review
                        headers: {"X-CSRFToken": '{{ csrf_token }}'}, // Include CSRF token
                        success: function (response) {
                            if (response.success) {
                                // Fade out and remove the review item
                                $reviewItem.fadeOut(300, function () {
                                    $(this).remove();
                                });
                            } else {
                                alert(response.error || 'An error occurred while deleting the review.');
                            }
                            $('#delete-confirm').remove(); // Remove the modal after deletion
                        },
                        error: function () {
                            alert('An error occurred while deleting the review.');
                            $('#delete-confirm').remove(); // Remove the modal on failure
                        }
                    });
                });

                // Handle cancel button
                $(document).off('click', '#cancel-delete').on('click', '#cancel-delete', function () {
                    $('#delete-confirm').remove(); // Remove the modal
                });
            });
        });
    </script>


{% endblock %}




